#!/usr/bin/env bash

DATAFILE=$1
ALGORITHM=$2
DATASET=$3
SUPPORT=$4
SAMPLES=$5

CACHE=$(mktemp --tmpdir -d sfp-cache-XXXXXXX)
OUTPUT=$(mktemp --tmpdir -d sfp-output-XXXXXXX)

function cleanup {
	line=(rm -rf $CACHE $OUTPUT)
	>&2 echo "${line[@]}"
	"${line[@]}"
}
trap cleanup 0

line=(sfp --skip-log=DEBUG --skip-log=INFO
		--output="$OUTPUT" --cache="$CACHE"
		--support="$SUPPORT" --samples="$SAMPLES" --non-unique
		$DATASET
		$ALGORITHM
		chain unique --histogram=histogram chain log -l SAMPLE -p unique file --show-pr)

>&2 echo $ "${line[@]}"
"${line[@]}"
>&2 echo

if [[ $ALGORITHM == graple* ]]
then
	line=(graple-selection-probabilities -m $OUTPUT/matrices.json)
	>&2 echo $ "${line[@]}" \> $OUTPUT/probabilities.prs
	"${line[@]}" > $OUTPUT/probabilities.prs
	>&2 echo
fi

line=(uniformity-test -e "$OUTPUT"/histogram.csv -p "$OUTPUT"/probabilities.prs)
>&2 echo $ "${line[@]}" \>\> "$DATAFILE"
"${line[@]}" >> "$DATAFILE"
>&2 echo

cleanup

>&2 echo
>&2 echo
